# **************************************************************************** #
#                                                                              #
#                                                         :::      ::::::::    #
#    Makefilej                                          :+:      :+:    :+:    #
#                                                     +:+ +:+         +:+      #
#    By: vserra <vserra@student.42.fr>              +#+  +:+       +#+         #
#                                                 +#+#+#+#+#+   +#+            #
#    Created: 2018/08/23 21:11:28 by jfortin           #+#    #+#              #
#    Updated: 2020/02/06 23:01:10 by vserra           ###   ########.fr        #
#                                                                              #
# **************************************************************************** #

NAME = libfts.a
NAME_TEST = testbin

ASFLAGS = -f macho64 -MD
CFLAGS = -Wall -Wextra -Werror -MMD

ifeq ($(DEBUG),yes)
	CFLAGS += -O0 -g -DDEBUG #-fsanitize=address,undefined
	ASFLAGS += -g
else
	CFLAGS += -O2 -flto -march=native
endif

SRC_NAME =	ft_bzero.s\
			ft_strcat.s\
			char_type_table.s\
			ft_isupper.s\
			ft_islower.s\
			ft_isalpha.s\
			ft_isdigit.s\
			ft_isalnum.s\
			ft_isprint.s\
			ft_isascii.s\
			ft_toupper.s\
			ft_tolower.s\
			ft_strlen.s\
			ft_puts.s\
			ft_memset.s\
			ft_memcpy.s\
			ft_strdup.s\
			ft_cat.s

SRC_TEST = test.c

SRC_DIR = src
TEST_DIR = test
BUILD_DIR = obj
INC_DIR = inc

OBJ = $(addprefix $(BUILD_DIR)/,$(SRC_NAME:.s=.o))
DPD = $(addsuffix .d,$(OBJ))

OBJ_TEST = $(addprefix $(BUILD_DIR)/,$(SRC_TEST:.c=.o))
DPD_TEST = $(addprefix $(BUILD_DIR)/,$(SRC_TEST:.c=.d))

opti:
	@$(MAKE) -j all

test: $(OBJ_TEST)
	@$(MAKE) opti
	gcc $(CFLAGS) $(OBJ_TEST) $(NAME) -o $(NAME_TEST)

debug:
	@$(MAKE) opti DEBUG=yes

all: $(NAME)

$(NAME): $(OBJ)
	@echo "\033[2K \033[A"
	@ar rcs $(NAME) $(OBJ)
	@echo "$(NAME) created"
	@echo "$(NAME_TEST)" > .gitignore

$(BUILD_DIR)/%.o: $(SRC_DIR)/%.s
	@mkdir -p $(BUILD_DIR)
	@echo "\033[2K [$(NAME)]: Compilation of $< \033[A"
	@nasm $(ASFLAGS) -o $@ $<

$(BUILD_DIR)/%.o: $(TEST_DIR)/%.c
	@mkdir -p $(BUILD_DIR)
	@echo "\033[2K [$(NAME_TEST)]: Compilation of $< \033[A"
	@gcc $(CFLAGS) -I $(INC_DIR) -c $< -o $@

clean:
	@rm -rf $(BUILD_DIR)
	@echo "[$(NAME)]: OBJ deleted"

fclean:
	@rm -f $(NAME)
	@echo "[$(NAME)]: deleted"
	@rm -f $(NAME_TEST)
	@echo "[$(NAME_TEST)]: deleted"
	@$(MAKE) clean

re :
	@$(MAKE) fclean
	@$(MAKE) opti

.PHONY: all, clean, fclean, re, $(TEST_DIR)

-include $(DPD)
-include $(DPD_TEST)